#include "emg_model.h"

#include <math.h>

const float scaler_mean[NUM_FEATURES] = {
    870.249096f,
    877.757712f,
    14052.526422f,
    5771.532275f,
    0.000000f,
    167.708986f,
    170.998103f,
    3265.885405f,
    1424.154470f,
    0.990853f,
    156.539763f,
    194.411374f,
    11626.443047f,
    4337.197963f,
    0.000000f,
    770.714846f,
    777.318243f,
    11042.611835f,
    2981.990680f,
    0.000000f,
};

const float scaler_scale[NUM_FEATURES] = {
    174.620030f,
    177.255661f,
    15482.226109f,
    1998.642386f,
    1.000000f,
    163.059712f,
    169.529667f,
    53501.473969f,
    1240.984745f,
    1.549133f,
    104.029863f,
    95.695197f,
    10016.151136f,
    2317.373145f,
    1.000000f,
    312.732925f,
    314.041745f,
    17083.672993f,
    1137.560259f,
    1.000000f,
};

const float lr_coefficients[NUM_CLASSES][NUM_FEATURES] = {
    {
        0.701082f,
        0.692634f,
        -0.035919f,
        -0.840525f,
        0.000000f,
        -0.234519f,
        -0.165085f,
        0.119659f,
        0.326184f,
        0.003341f,
        0.766378f,
        1.311006f,
        -0.230797f,
        -0.947962f,
        0.000000f,
        -0.097309f,
        -0.073184f,
        -0.126313f,
        0.143326f,
        0.000000f,
    },
    {
        -0.822451f,
        -0.784705f,
        -0.119189f,
        -0.752688f,
        0.000000f,
        -0.290754f,
        -0.327478f,
        0.006509f,
        0.536962f,
        0.006696f,
        -0.973082f,
        -0.028545f,
        0.677529f,
        0.766109f,
        0.000000f,
        0.408979f,
        0.402307f,
        0.143580f,
        -1.403884f,
        0.000000f,
    },
    {
        -0.203233f,
        -0.196695f,
        0.008421f,
        0.468448f,
        0.000000f,
        0.310467f,
        0.332471f,
        -0.451991f,
        -0.930483f,
        -0.567859f,
        0.912674f,
        -0.608292f,
        -1.329589f,
        0.782118f,
        0.000000f,
        1.074380f,
        1.076727f,
        0.004755f,
        0.231875f,
        0.000000f,
    },
    {
        -0.057638f,
        0.137080f,
        0.401245f,
        -1.116454f,
        0.000000f,
        0.167654f,
        -0.084146f,
        0.045308f,
        0.195506f,
        0.124183f,
        -0.499177f,
        -0.319779f,
        -1.361484f,
        1.880547f,
        0.000000f,
        0.289335f,
        0.331159f,
        -0.176486f,
        -0.196585f,
        0.000000f,
    },
    {
        0.369284f,
        0.360846f,
        -0.065838f,
        -0.346922f,
        0.000000f,
        -0.702258f,
        -0.734240f,
        -0.074644f,
        0.559985f,
        0.191510f,
        -2.521227f,
        -0.738361f,
        0.819964f,
        0.266455f,
        0.000000f,
        0.487504f,
        0.494877f,
        -0.021697f,
        -0.439446f,
        0.000000f,
    },
    {
        0.637329f,
        0.626039f,
        -0.950013f,
        0.426002f,
        0.000000f,
        -0.283664f,
        -0.003179f,
        0.055031f,
        0.681442f,
        -0.077387f,
        -2.233019f,
        -1.023142f,
        -1.229884f,
        1.224880f,
        0.000000f,
        0.182627f,
        0.161151f,
        0.200858f,
        0.030632f,
        0.000000f,
    },
    {
        -0.643622f,
        -0.641112f,
        -0.824661f,
        2.551218f,
        0.000000f,
        0.650512f,
        0.689804f,
        0.027287f,
        -1.546805f,
        -1.074804f,
        1.148762f,
        -0.463876f,
        -3.060671f,
        -0.539238f,
        0.000000f,
        0.432707f,
        0.371592f,
        -0.101832f,
        -1.069921f,
        0.000000f,
    },
    {
        0.190719f,
        0.178735f,
        -0.414954f,
        1.442502f,
        0.000000f,
        0.479607f,
        0.469809f,
        0.051531f,
        -1.769524f,
        0.009425f,
        2.102666f,
        -0.999957f,
        -1.917282f,
        0.447202f,
        0.000000f,
        1.167983f,
        1.164930f,
        0.115036f,
        -0.936051f,
        0.000000f,
    },
    {
        0.991528f,
        0.927891f,
        -1.459628f,
        1.284920f,
        0.000000f,
        0.288503f,
        0.275432f,
        -0.266114f,
        -0.144713f,
        -0.046007f,
        -0.829684f,
        -1.616972f,
        -1.811194f,
        -0.373759f,
        0.000000f,
        -0.424040f,
        -0.479508f,
        0.067905f,
        1.061781f,
        0.000000f,
    },
    {
        -0.730916f,
        -0.705316f,
        0.353261f,
        -1.002274f,
        0.000000f,
        -0.388769f,
        -0.344161f,
        0.137498f,
        0.125886f,
        0.168317f,
        -0.284399f,
        -0.244626f,
        0.871770f,
        -0.333871f,
        0.000000f,
        -1.628976f,
        -1.581934f,
        0.130344f,
        0.201889f,
        0.000000f,
    },
};

const float lr_intercept[NUM_CLASSES] = {
    -4.449267f,
    -3.677988f,
    -3.152548f,
    -2.943950f,
    -4.555717f,
    -3.885681f,
    -4.402037f,
    -4.034091f,
    -4.635200f,
    -5.802713f,
};

const char* gesture_names[NUM_CLASSES] = {
    "rock",
    "scissors",
    "paper",
    "fuck",
    "three",
    "four",
    "good",
    "okay",
    "finger-gun",
    "rest",
};


GestureType predict_gesture(const float* features) {
    float scores[NUM_CLASSES] = {0};
    float max_score = -INFINITY;
    int predicted_class = 0;
    
    float scaled_features[NUM_FEATURES];
    for (int i = 0; i < NUM_FEATURES; i++) {
        scaled_features[i] = (features[i] - scaler_mean[i]) / scaler_scale[i];
    }
    
    for (int class_idx = 0; class_idx < NUM_CLASSES; class_idx++) {
        scores[class_idx] = lr_intercept[class_idx];
        for (int feat_idx = 0; feat_idx < NUM_FEATURES; feat_idx++) {
            scores[class_idx] += lr_coefficients[class_idx][feat_idx] * scaled_features[feat_idx];
        }
        if (scores[class_idx] > max_score) {
            max_score = scores[class_idx];
            predicted_class = class_idx;
        }
    }
    
    return (GestureType)predicted_class;
}
