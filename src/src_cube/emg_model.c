#include "emg_model.h"

#include <math.h>

const float scaler_mean[NUM_FEATURES] = {
    112.882840f,
    116.614858f,
    1422.591129f,
    1019.890058f,
    0.000000f,
    182.508642f,
    188.341901f,
    4181.897491f,
    2092.911284f,
    1.388062f,
    283.383482f,
    296.026663f,
    7070.144137f,
    3273.239296f,
    0.000000f,
    664.386578f,
    672.322491f,
    14627.344108f,
    4668.448657f,
    0.000000f,
};

const float scaler_scale[NUM_FEATURES] = {
    62.327444f,
    66.714404f,
    9444.853472f,
    1213.347108f,
    1.000000f,
    188.497363f,
    193.777929f,
    58808.967954f,
    1398.418416f,
    1.659785f,
    150.449234f,
    149.597892f,
    9836.993475f,
    2035.926661f,
    1.000000f,
    308.612081f,
    315.056748f,
    21582.504336f,
    2790.686609f,
    1.000000f,
};

const float lr_coefficients[NUM_CLASSES][NUM_FEATURES] = {
    {
        1.619552f,
        1.245846f,
        -0.756691f,
        -1.931803f,
        0.000000f,
        1.208392f,
        1.132082f,
        0.056144f,
        -1.178565f,
        -0.549058f,
        -0.479664f,
        -0.772317f,
        -1.605963f,
        -0.796760f,
        0.000000f,
        0.816880f,
        0.778964f,
        -1.209758f,
        1.241393f,
        0.000000f,
    },
    {
        0.165102f,
        -0.679612f,
        -0.546617f,
        1.193623f,
        0.000000f,
        0.188771f,
        0.201698f,
        -0.285062f,
        -1.254320f,
        -0.513664f,
        -0.222570f,
        -0.297001f,
        -1.074054f,
        0.878717f,
        0.000000f,
        0.480075f,
        0.431942f,
        -2.262421f,
        -0.098968f,
        0.000000f,
    },
    {
        -2.514950f,
        -2.635945f,
        -0.183804f,
        0.648822f,
        0.000000f,
        0.368638f,
        0.295336f,
        0.058807f,
        0.114299f,
        0.056541f,
        1.502139f,
        1.465446f,
        -0.298242f,
        -1.767602f,
        0.000000f,
        -0.680290f,
        -0.668621f,
        0.227801f,
        0.160825f,
        0.000000f,
    },
    {
        0.832858f,
        0.755790f,
        -0.904002f,
        0.350424f,
        0.000000f,
        -0.113231f,
        -0.147587f,
        0.023819f,
        0.810164f,
        0.260853f,
        -1.646736f,
        -1.619772f,
        0.405755f,
        0.121052f,
        0.000000f,
        -1.162645f,
        -1.147429f,
        0.673694f,
        -0.730650f,
        0.000000f,
    },
    {
        -0.276550f,
        -0.249633f,
        0.147425f,
        -0.971481f,
        0.000000f,
        -1.177846f,
        -1.141030f,
        -0.057397f,
        0.315380f,
        0.099135f,
        -0.431690f,
        -0.155652f,
        0.802267f,
        -0.214903f,
        0.000000f,
        0.601095f,
        0.563857f,
        0.116377f,
        -0.069809f,
        0.000000f,
    },
    {
        0.481961f,
        0.435169f,
        -0.271198f,
        -0.945140f,
        0.000000f,
        -0.844562f,
        -0.789518f,
        0.176461f,
        -0.109502f,
        0.048798f,
        -1.373397f,
        -0.879237f,
        -2.023881f,
        1.399941f,
        0.000000f,
        0.454082f,
        0.627174f,
        -0.176361f,
        0.330492f,
        0.000000f,
    },
    {
        0.003622f,
        -0.034843f,
        -0.196139f,
        1.008385f,
        0.000000f,
        -1.032929f,
        -0.933164f,
        -0.107321f,
        1.096536f,
        0.182528f,
        1.082878f,
        1.127444f,
        0.211046f,
        0.118402f,
        0.000000f,
        -0.337818f,
        -0.334479f,
        0.017879f,
        -0.525934f,
        0.000000f,
    },
    {
        -1.212421f,
        -1.280520f,
        -0.299306f,
        0.382563f,
        0.000000f,
        0.305506f,
        0.255576f,
        0.072260f,
        -0.395962f,
        -0.253837f,
        1.692479f,
        1.076953f,
        -2.495564f,
        0.448622f,
        0.000000f,
        0.983897f,
        1.019449f,
        -0.131928f,
        1.348567f,
        0.000000f,
    },
    {
        -0.641805f,
        -0.445390f,
        0.037597f,
        -1.056075f,
        0.000000f,
        0.608518f,
        0.492168f,
        -0.012180f,
        -0.039828f,
        0.020136f,
        0.732607f,
        0.363510f,
        -3.596425f,
        0.367863f,
        0.000000f,
        0.342101f,
        0.505744f,
        -0.843961f,
        1.667934f,
        0.000000f,
    },
    {
        -0.965659f,
        -0.779983f,
        0.551355f,
        -0.559749f,
        0.000000f,
        -0.733777f,
        -0.649089f,
        0.271970f,
        -0.867720f,
        -0.181502f,
        -1.062695f,
        -1.108717f,
        0.008975f,
        0.215550f,
        0.000000f,
        -0.319494f,
        -0.359919f,
        -0.530503f,
        -0.403023f,
        0.000000f,
    },
};

const float lr_intercept[NUM_CLASSES] = {
    -3.396504f,
    -3.310750f,
    -4.255962f,
    -4.397293f,
    -4.202608f,
    -3.832570f,
    -4.079858f,
    -4.445653f,
    -2.839509f,
    -5.507957f,
};

const char* gesture_names[NUM_CLASSES] = {
    "rock",
    "scissors",
    "paper",
    "fuck",
    "three",
    "four",
    "good",
    "okay",
    "finger-gun",
    "rest",
};


GestureType predict_gesture(const float* features) {
    float scores[NUM_CLASSES] = {0};
    float max_score = -INFINITY;
    int predicted_class = 0;
    
    // Scale features
    float scaled_features[NUM_FEATURES];
    for (int i = 0; i < NUM_FEATURES; i++) {
        scaled_features[i] = (features[i] - scaler_mean[i]) / scaler_scale[i];
    }
    
    // Calculate scores for each class (One-vs-Rest)
    for (int class_idx = 0; class_idx < NUM_CLASSES; class_idx++) {
        scores[class_idx] = lr_intercept[class_idx];
        
        for (int feat_idx = 0; feat_idx < NUM_FEATURES; feat_idx++) {
            scores[class_idx] += lr_coefficients[class_idx][feat_idx] * scaled_features[feat_idx];
        }
        
        // Keep track of maximum score
        if (scores[class_idx] > max_score) {
            max_score = scores[class_idx];
            predicted_class = class_idx;
        }
    }
    
    return (GestureType)predicted_class;
}
